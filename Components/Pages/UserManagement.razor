@page "/admin/users"
@using Microsoft.AspNetCore.Authorization
@using WorkTicketApp.Models
@using WorkTicketApp.Services
@attribute [Authorize(Roles = "Admin")]
@inject IUserService UserService
@inject IJSRuntime JSRuntime

<PageTitle>User Management</PageTitle>

<div class="container mt-4">
    <h2 class="mb-4">User Management</h2>

    <div class="row">
        <!-- Add User Form -->
        <div class="col-md-4">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Add New User</h5>
                </div>
                <div class="card-body">
                    <EditForm Model="@newUser" OnValidSubmit="HandleAddUser">
                        <DataAnnotationsValidator />
                        <ValidationSummary class="text-danger" />

                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <InputText @bind-Value="newUser.Username" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <InputText @bind-Value="newUser.Password" type="password" class="form-control" />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Role</label>
                            <InputSelect @bind-Value="newUser.Role" class="form-select">
                                <option value="User">User</option>
                                <option value="Admin">Admin</option>
                            </InputSelect>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Create User</button>
                    </EditForm>
                </div>
            </div>
        </div>

        <!-- User List -->
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header bg-light">
                    <h5 class="mb-0">Existing Users</h5>
                </div>
                <div class="card-body">
                    @if (users == null)
                    {
                        <div class="text-center my-3">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </div>
                    }
                    else if (!users.Any())
                    {
                        <div class="alert alert-info">No users found.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover align-middle">
                                <thead class="table-light">
                                    <tr>
                                        <th>Username</th>
                                        <th>Role</th>
                                        <th class="text-end">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in users)
                                    {
                                        <tr>
                                            <td>@user.Username</td>
                                            <td>
                                                <span class="badge @(user.Role == "Admin" ? "bg-danger" : "bg-secondary")">
                                                    @user.Role
                                                </span>
                                            </td>
                                            <td class="text-end">
                                                <button class="btn btn-outline-danger btn-sm" @onclick="() => DeleteUser(user.Username)">
                                                    <i class="fa-solid fa-trash"></i> Delete
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private List<UserDto> users = new();
    private RegisterModel newUser = new();

    public class RegisterModel
    {
        [System.ComponentModel.DataAnnotations.Required]
        public string Username { get; set; } = "";
        
        [System.ComponentModel.DataAnnotations.Required]
        public string Password { get; set; } = "";
        
        public string Role { get; set; } = "User";
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
    }

    private async Task LoadUsers()
    {
        var userEntities = await UserService.GetAllUsersAsync();
        users = userEntities.Select(u => new UserDto { Username = u.Username, Role = u.Role }).ToList();
    }

    private async Task HandleAddUser()
    {
        var success = await UserService.RegisterAsync(newUser.Username, newUser.Password, newUser.Role);
        
        if (success)
        {
            newUser = new RegisterModel(); // Reset form
            await LoadUsers();
        }
        else
        {
            await JSRuntime.InvokeVoidAsync("alert", "Failed to create user. Username may already exist.");
        }
    }

    private async Task DeleteUser(string username)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"Are you sure you want to delete user '{username}'?"))
        {
            await UserService.DeleteUserAsync(username);
            await LoadUsers();
        }
    }
}