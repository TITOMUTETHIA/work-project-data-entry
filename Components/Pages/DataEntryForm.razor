@page "/tickets"
@using Microsoft.AspNetCore.Authorization
@inject IWorkTicketService TicketService
@inject IJSRuntime JSRuntime
@attribute [Authorize]

<h3 class="text-primary mb-4">ðŸ“‘ Saved Work Tickets</h3>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="input-group">
            <input type="text" class="form-control" placeholder="Search by Ticket #, Operator, or Activity..." 
                   @bind="searchTerm" @bind:event="oninput" @onkeyup="SearchTickets" />
            <button class="btn btn-outline-primary" @onclick="SearchTickets">Search</button>
        </div>
    </div>
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text">From</span>
            
            <input type="date" class="form-control" @bind="filterStartDate" />
            <span class="input-group-text">To</span>
            <input type="date" class="form-control" @bind="filterEndDate" />
            <button class="btn btn-outline-secondary" @onclick="SearchTickets">Filter</button>
        </div>
    </div>
</div>

@if (tickets == null || tickets.Count == 0)
{
    <div class="alert alert-info">No work tickets have been saved yet.</div>
}
else if (editingTicketNumber != null)
{
    <div class="card p-4 mb-4">
        <h4>Edit Work Ticket: @editingTicketNumber</h4>
        <form>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Cost Centre</label>
                    <input type="text" class="form-control" @bind="editingTicket!.CostCentre" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Activity</label>
                    <input type="text" class="form-control" @bind="editingTicket.Activity" />
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Operator Name</label>
                    <input type="text" class="form-control" @bind="editingTicket.OperatorName" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">Number of Operators</label>
                    <input type="number" class="form-control" @bind="editingTicket.NumOperators" />
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-6">
                    <label class="form-label">Start Date/Time</label>
                    <input type="datetime-local" class="form-control" @bind="editingTicket.StartDateTime" />
                </div>
                <div class="col-md-6">
                    <label class="form-label">End Date/Time</label>
                    <input type="datetime-local" class="form-control" @bind="editingTicket.EndDateTime" />
                </div>
            </div>
            <div class="row mb-3">
                <div class="col-md-4">
                    <label class="form-label">Quantity In</label>
                    <input type="number" class="form-control" @bind="editingTicket.QuantityIn" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Quantity Out</label>
                    <input type="number" class="form-control" @bind="editingTicket.QuantityOut" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Material Used</label>
                    <input type="text" class="form-control" @bind="editingTicket.MaterialUsed" />
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-success" @onclick="SaveChanges">Save Changes</button>
                <button type="button" class="btn btn-secondary ms-2" @onclick="CancelEdit">Cancel</button>
            </div>
        </form>
    </div>
}
else
{
    <table class="table table-striped table-bordered shadow-sm">
        <thead class="table-dark">
            <tr>
                <th style="cursor: pointer" @onclick='() => SortBy("TicketNumber")'>Ticket # @GetSortIcon("TicketNumber")</th>
                <th style="cursor: pointer" @onclick='() => SortBy("CostCentre")'>Cost Centre @GetSortIcon("CostCentre")</th>
                <th style="cursor: pointer" @onclick='() => SortBy("Activity")'>Activity @GetSortIcon("Activity")</th>
                <th style="cursor: pointer" @onclick='() => SortBy("OperatorName")'>Operator @GetSortIcon("OperatorName")</th>
                <th>Num Operators</th>
                <th>Start</th>
                <th>End</th>
                <th>Qty In</th>
                <th>Qty Out</th>
                <th>Material Used</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var t in tickets)
            {
                <tr>
                    <td>@t.TicketNumber</td>
                    <td>@t.CostCentre</td>
                    <td>@t.Activity</td>
                    <td>@t.OperatorName</td>
                    <td>@t.NumOperators</td>
                    <td>@t.StartDateTime.ToString("g")</td>
                    <td>@t.EndDateTime.ToString("g")</td>
                    <td>@t.QuantityIn</td>
                    <td>@t.QuantityOut</td>
                    <td>@t.MaterialUsed</td>
                    <td>
                        @if (t.TicketNumber is not null)
                        {
                            <button class="btn btn-sm btn-primary" @onclick="() => EditTicket(t.TicketNumber)">Edit</button>
                            <button class="btn btn-sm btn-danger ms-1" @onclick="() => DeleteTicket(t.Id)">Delete</button>
                        }
                    </td>
                </tr>
            }
        </tbody>
    </table>

    <div class="d-flex justify-content-between align-items-center mt-3">
        <div>
            Showing @((currentPage - 1) * pageSize + 1) to @(Math.Min(currentPage * pageSize, totalCount)) of @totalCount entries
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination mb-0">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage - 1)">Previous</button>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Page @currentPage of @totalPages</span>
                </li>
                <li class="page-item @(currentPage >= totalPages ? "disabled" : "")">
                    <button class="page-link" @onclick="() => ChangePage(currentPage + 1)">Next</button>
                </li>
            </ul>
        </nav>
    </div>
}

@code {
    private List<WorkTicket> tickets = new();
    private string? editingTicketNumber = null;
    private WorkTicket? editingTicket = null;
    private string searchTerm = "";
    private int currentPage = 1;
    private int pageSize = 10;
    private int totalCount = 0;
    private int totalPages => totalCount == 0 ? 1 : (int)Math.Ceiling((double)totalCount / pageSize);
    private string sortBy = "CreatedAt";
    private bool sortAscending = false;
    private DateTime? filterStartDate;
    private DateTime? filterEndDate;

    protected override async Task OnInitializedAsync()
    {
        await SearchTickets();
    }

    private async Task LoadTickets()
    {
        var result = await TicketService.GetWorkTicketsAsync(currentPage, pageSize, searchTerm, sortBy, sortAscending, filterStartDate, filterEndDate);
        tickets = result.Items;
        totalCount = result.TotalCount;
    }

    private async Task SearchTickets()
    {
        currentPage = 1;
        await LoadTickets();
    }

    private async Task SortBy(string column)
    {
        if (sortBy == column)
        {
            sortAscending = !sortAscending;
        }
        else
        {
            sortBy = column;
            sortAscending = true;
        }
        await LoadTickets();
    }

    private string GetSortIcon(string column)
    {
        if (sortBy != column) return "";
        return sortAscending ? "â–²" : "â–¼";
    }

    private async Task ChangePage(int newPage)
    {
        if (newPage < 1 || newPage > totalPages) return;
        currentPage = newPage;
        await LoadTickets();
    }

    private void EditTicket(string? ticketNumber)
    {
        if (ticketNumber == null) return;
        
        var ticket = tickets.FirstOrDefault(t => t.TicketNumber == ticketNumber);
        if (ticket != null)
        {
            editingTicketNumber = ticketNumber;
            // Create a copy for editing
            editingTicket = new WorkTicket
            {
                Id = ticket.Id,
                TicketNumber = ticket.TicketNumber,
                CostCentre = ticket.CostCentre,
                Activity = ticket.Activity,
                OperatorName = ticket.OperatorName,
                NumOperators = ticket.NumOperators,
                StartDateTime = ticket.StartDateTime,
                StartCounter = ticket.StartCounter,
                EndDateTime = ticket.EndDateTime,
                EndCounter = ticket.EndCounter,
                QuantityIn = ticket.QuantityIn,
                QuantityOut = ticket.QuantityOut,
                MaterialUsed = ticket.MaterialUsed
            };
        }
    }

    private async Task SaveChanges()
    {
        if (editingTicket != null && editingTicketNumber != null)
        {
            await TicketService.UpdateTicketAsync(editingTicket);
            
            // Refresh list
            await LoadTickets();
        }
        CancelEdit();
    }

    private void CancelEdit()
    {
        editingTicketNumber = null;
        editingTicket = null;
    }

    private async Task DeleteTicket(int id)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this ticket?"))
        {
            await TicketService.DeleteTicketAsync(id);
            await LoadTickets();
            if (tickets.Count == 0 && currentPage > 1)
            {
                currentPage--;
                await LoadTickets();
            }
        }
    }
}